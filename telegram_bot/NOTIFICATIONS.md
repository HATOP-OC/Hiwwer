# Telegram Notifications Integration

## –û–≥–ª—è–¥

–°–∏—Å—Ç–µ–º–∞ —Å–ø–æ–≤—ñ—â–µ–Ω—å —ñ–Ω—Ç–µ–≥—Ä–æ–≤–∞–Ω–∞ –∑ Telegram –±–æ—Ç–æ–º –¥–ª—è –º–∏—Ç—Ç—î–≤–æ—ó –¥–æ—Å—Ç–∞–≤–∫–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º.

## –Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î

1. **–°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è**: –ö–æ–ª–∏ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –ø–æ–¥—ñ—è (–Ω–æ–≤e –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è, –∑–º—ñ–Ω–∞ —Å—Ç–∞—Ç—É—Å—É, –Ω–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —Ç–æ—â–æ), backend —Å—Ç–≤–æ—Ä—é—î –∑–∞–ø–∏—Å —É —Ç–∞–±–ª–∏—Ü—ñ `notifications`
2. **WebSocket**: –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –º–∏—Ç—Ç—î–≤–æ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î—Ç—å—Å—è —á–µ—Ä–µ–∑ WebSocket –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º, —â–æ –æ–Ω–ª–∞–π–Ω –Ω–∞ —Å–∞–π—Ç—ñ
3. **Telegram Bot**: Notification Service –≤ Telegram –±–æ—Ç—ñ –ø–µ—Ä—ñ–æ–¥–∏—á–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î –Ω–æ–≤—ñ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è —Ç–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î —ó—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º –≤ Telegram

## –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞

```
Backend API
    ‚îÇ
    ‚îú‚îÄ‚Üí WebSocket (real-time –¥–ª—è —Å–∞–π—Ç—É)
    ‚îÇ       ‚îî‚îÄ‚Üí –§—Ä–æ–Ω—Ç–µ–Ω–¥ –æ—Ç—Ä–∏–º—É—î —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è
    ‚îÇ
    ‚îî‚îÄ‚Üí Database (notifications table)
            ‚îî‚îÄ‚Üí Telegram Bot (polling)
                    ‚îî‚îÄ‚Üí –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –≤ Telegram —á–∞—Ç
```

## –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è

### 1. –ë–∞–∑–∞ –¥–∞–Ω–∏—Ö

–ú—ñ–≥—Ä–∞—Ü—ñ—è `004_telegram_notifications.sql` –¥–æ–¥–∞—î –ø–æ–ª—è:
- `telegram_sent` - —á–∏ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram
- `telegram_sent_at` - —á–∞—Å –≤—ñ–¥–ø—Ä–∞–≤–∫–∏

### 2. Backend API

–ù–æ–≤—ñ –µ–Ω–¥–ø–æ—ñ–Ω—Ç–∏ –≤ `/v1/notifications`:

- `GET /pending-telegram` - –û—Ç—Ä–∏–º–∞—Ç–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –≤ Telegram
- `PATCH /:id/telegram-sent` - –í—ñ–¥–º—ñ—Ç–∏—Ç–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è —è–∫ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–µ
- `GET /users/:userId/telegram-chat` - –û—Ç—Ä–∏–º–∞—Ç–∏ chat_id –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞

### 3. Telegram Bot

–§–∞–π–ª–∏:
- `notifications.py` - Helper —Ñ—É–Ω–∫—Ü—ñ—ó –¥–ª—è —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è —Ç–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏
- `notification_service.py` - –°–µ—Ä–≤—ñ—Å –¥–ª—è polling —Å–ø–æ–≤—ñ—â–µ–Ω—å –∑ backend

–°–µ—Ä–≤—ñ—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è —Ä–∞–∑–æ–º –∑ –±–æ—Ç–æ–º.

## –¢–∏–ø–∏ —Å–ø–æ–≤—ñ—â–µ–Ω—å

| –¢–∏–ø | Emoji | –û–ø–∏—Å |
|-----|-------|------|
| `message` | üí¨ | –ù–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ —á–∞—Ç—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è |
| `new_order` | üõí | –ù–æ–≤–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–≤–æ—Ä–µ–Ω–æ |
| `status_change` | üîÑ | –°—Ç–∞—Ç—É—Å –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –∑–º—ñ–Ω–µ–Ω–æ |
| `deadline` | ‚è∞ | –ù–∞–±–ª–∏–∂–∞—î—Ç—å—Å—è –¥–µ–¥–ª–∞–π–Ω |
| `payment` | üí∞ | –ü–ª–∞—Ç—ñ–∂ –æ—Ç—Ä–∏–º–∞–Ω–æ/–Ω–∞–¥—ñ—Å–ª–∞–Ω–æ |
| `review` | ‚≠ê | –ù–æ–≤–∏–π –≤—ñ–¥–≥—É–∫ |
| `dispute` | ‚ö†Ô∏è | –ù–æ–≤–∏–π –¥–∏—Å–ø—É—Ç –∞–±–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è |

## –ü—Ä–∏–∫–ª–∞–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è

### –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è (Backend)

```typescript
import { createNotification } from './services/notificationService';

// –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ –Ω–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
await createNotification(
  userId,
  'message',
  `–ù–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—ñ "${orderTitle}"`,
  orderId
);

// –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ –∑–º—ñ–Ω—É —Å—Ç–∞—Ç—É—Å—É
await createNotification(
  userId,
  'status_change',
  `–°—Ç–∞—Ç—É—Å –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è "${orderTitle}" –∑–º—ñ–Ω–µ–Ω–æ –Ω–∞ ${newStatus}`,
  orderId
);
```

### –û—Ç—Ä–∏–º–∞–Ω–Ω—è –≤ Telegram (Bot)

–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ—Ç—Ä–∏–º–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ Telegram —á–∞—Ç—ñ:

```
üîî –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è

–°—Ç–∞—Ç—É—Å –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è "–°—Ç–≤–æ—Ä–∏—Ç–∏ –≤–µ–±-—Å–∞–π—Ç" –∑–º—ñ–Ω–µ–Ω–æ –Ω–∞ in_progress

–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è: https://your-domain.com/orders/123
```

## –†–æ–±–æ—á–∏–π –ø—Ä–æ—Ü–µ—Å

1. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –ø—Ä–∏–≤'—è–∑—É—î Telegram —á–µ—Ä–µ–∑ `/link <code>` –∫–æ–º–∞–Ω–¥—É
2. Backend –∑–±–µ—Ä—ñ–≥–∞—î `chat_id` –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
3. –ü—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ –ø–æ–¥—ñ—ó:
   - –°—Ç–≤–æ—Ä—é—î—Ç—å—Å—è –∑–∞–ø–∏—Å –≤ `notifications` –∑ `telegram_sent = false`
   - –í—ñ–¥–ø—Ä–∞–≤–ª—è—î—Ç—å—Å—è —á–µ—Ä–µ–∑ WebSocket –Ω–∞ —Å–∞–π—Ç
4. Telegram Bot polling:
   - –ö–æ–∂–Ω—ñ 5 —Å–µ–∫—É–Ω–¥ –∑–∞–ø–∏—Ç—É—î `/pending-telegram`
   - –í—ñ–¥–ø—Ä–∞–≤–ª—è—î —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –≤ Telegram
   - –í—ñ–¥–º—ñ—á–∞—î —è–∫ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–µ —á–µ—Ä–µ–∑ `/telegram-sent`

## –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≤ .env

```env
# Backend
BACKEND_API_URL=http://localhost:3000/v1

# Telegram Bot
TG_API=your_telegram_bot_token
BACKEND_API_URL=http://localhost:3000/v1
```

## –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥

–õ–æ–≥–∏ Telegram –±–æ—Ç–∞ –ø–æ–∫–∞–∑—É—é—Ç—å:
- –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ WebSocket
- –û—Ç—Ä–∏–º–∞–Ω–Ω—è –Ω–æ–≤–∏—Ö —Å–ø–æ–≤—ñ—â–µ–Ω—å
- –£—Å–ø—ñ—à–Ω—ñ/–Ω–µ–≤–¥–∞–ª—ñ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏
- –ü–æ–º–∏–ª–∫–∏

```
INFO - Notification service started
INFO - Notification sent to chat_id=123456, type=message
WARNING - No chat_id found for user abc-123-def
ERROR - Failed to send Telegram notification: ...
```

## Troubleshooting

### –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç—å –≤ Telegram

1. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –ø—Ä–∏–≤'—è–∑–∞–≤ Telegram: `SELECT chat_id FROM users WHERE id = 'user-id'`
2. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥–∏ –±–æ—Ç–∞ –Ω–∞ –ø–æ–º–∏–ª–∫–∏
3. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ –ø—Ä–∞—Ü—é—î Notification Service: –ø–æ–≤–∏–Ω–µ–Ω –±—É—Ç–∏ –ª–æ–≥ "Notification service started"

### –î—É–±–ª—ñ–∫–∞—Ç–∏ —Å–ø–æ–≤—ñ—â–µ–Ω—å

- –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤—ñ–¥–º—ñ—á–∞—é—Ç—å—Å—è —è–∫ `telegram_sent = true`
- –ü–æ–¥–∏–≤—ñ—Ç—å—Å—è SQL: `SELECT * FROM notifications WHERE telegram_sent = false`

### WebSocket –Ω–µ –ø—Ä–∞—Ü—é—î

- –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ –∑–∞–ø—É—â–µ–Ω–∏–π backend –Ω–∞ –ø–æ—Ä—Ç—É 3000
- –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ CORS –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
- –í –±—Ä–∞—É–∑–µ—Ä—ñ: DevTools ‚Üí Network ‚Üí WS –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ WebSocket –∑'—î–¥–Ω–∞–Ω–Ω—è
