# Система бекапів бази даних

Цей документ описує роботу з системою бекапів бази даних для Digi Hub Telegram Sales.

## Огляд

Система підтримує два способи створення та управління бекапами:

1. **Через веб-інтерфейс адміністратора** - зручний спосіб для ручного управління
2. **Через командний рядок** - для автоматизації та cron задач

## Веб-інтерфейс адміністратора

### Доступ

1. Увійдіть в систему як адміністратор
2. Перейдіть в розділ "Панель адміна"
3. Оберіть вкладку "База даних"

### Функціональність

- **Перегляд статистики БД**: кількість таблиць, записів, розмір бази
- **Створення бекапів**: миттєве створення повного дампу бази
- **Список бекапів**: перегляд всіх доступних бекапів з датами та розмірами
- **Завантаження бекапів**: завантаження .sql файлів на локальний комп'ютер
- **Відновлення з бекапу**: повне відновлення бази даних з обраного бекапу
- **Видалення бекапів**: очищення непотрібних файлів бекапів

### Безпека

⚠️ **УВАГА**: Відновлення бази даних замінює всі поточні дані!

- Завжди створюйте бекап перед відновленням
- Переконайтеся, що ви обрали правильний файл
- Операція відновлення незворотна

## Командний рядок

### Скрипт backup-db.sh

Основний скрипт для роботи з бекапами знаходиться в корені проекту.

#### Використання

```bash
# Ручне створення бекапу
./backup-db.sh manual

# Автоматичне створення (для cron)
./backup-db.sh auto

# Створення через API
./backup-db.sh api

# Допомога
./backup-db.sh --help
```

#### Конфігурація

Скрипт використовує змінні середовища з файлу `.env`:

```bash
# Підключення до бази даних
DATABASE_URL=postgresql://username:password@host:port/database

# Директорія для бекапів
BACKUP_DIR=./server/backups

# Максимальна кількість бекапів
MAX_BACKUPS=10

# Токен адміністратора (для API режиму)
ADMIN_TOKEN=your_admin_token
```

### Автоматизація (Cron)

1. Скопіюйте налаштування з `backup-cron.txt`:
```bash
crontab backup-cron.txt
```

2. Або додайте задачі вручну:
```bash
crontab -e
```

Приклади розкладів:
- `0 2 * * *` - щодня о 2:00 ночі
- `0 */6 * * *` - кожні 6 годин
- `0 3 * * 0` - щонеділі о 3:00

### Логування

Автоматичні бекапи записують логи в:
- `/var/log/db-backup.log` - щоденні бекапи
- `/var/log/db-backup-weekly.log` - тижневі бекапи

## API Endpoints

### Статистика бази даних
```
GET /v1/admin/database/stats
Authorization: Bearer <token>
```

### Список бекапів
```
GET /v1/admin/database/backups
Authorization: Bearer <token>
```

### Створення бекапу
```
POST /v1/admin/database/backup
Authorization: Bearer <token>
```

### Завантаження бекапу
```
GET /v1/admin/database/backup/:filename
Authorization: Bearer <token>
```

### Відновлення з бекапу
```
POST /v1/admin/database/restore
Authorization: Bearer <token>
Content-Type: application/json

{
  "filename": "backup_2024-01-01_12-00-00.sql"
}
```

### Видалення бекапу
```
DELETE /v1/admin/database/backup/:filename
Authorization: Bearer <token>
```

## Структура файлів

```
project/
├── backup-db.sh              # Основний скрипт бекапів
├── backup-cron.txt           # Конфігурація cron
├── server/
│   ├── backups/              # Директорія бекапів
│   │   ├── backup_2024-01-01_12-00-00.sql
│   │   └── backup_2024-01-02_12-00-00.sql
│   └── src/
│       └── services/
│           └── backupService.ts  # Сервіс бекапів
└── src/
    └── pages/
        └── admin/
            └── Database.tsx      # Веб-інтерфейс
```

## Рекомендації

### Частота бекапів

- **Критичні дані**: кожні 6 годин
- **Звичайне використання**: щодня
- **Низька активність**: щотижня

### Зберігання

- Локально: останні 10 бекапів
- Віддалено: щомісячні архіви
- Хмарне сховище: критичні бекапи

### Тестування

Регулярно тестуйте процес відновлення:

1. Створіть тестову базу даних
2. Відновіть останній бекап
3. Перевірте цілісність даних
4. Документуйте проблеми

## Усунення проблем

### Помилки створення бекапу

1. Перевірте підключення до БД
2. Переконайтеся, що pg_dump встановлено
3. Перевірте права доступу до директорії
4. Переглянте логи помилок

### Помилки відновлення

1. Перевірте, чи існує файл бекапу
2. Перевірте права користувача БД
3. Переконайтеся, що база даних доступна
4. Перевірте цілісність .sql файлу

### Проблеми з місцем на диску

1. Налаштуйте автоочищення старих бекапів
2. Стисніть бекапи (gzip)
3. Перемістіть старі бекапи в архів
4. Налаштуйте моніторинг дискового простору

## Контакти

За питаннями роботи з системою бекапів звертайтеся до системного адміністратора.
